---
title:  "Adjusted Home Run Frequencies" 
author: Jason Osborne and Rich Levine
output:
  pdf_document
---

<!-- the 2022 in the title is a leftover, please ignore it. -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE,eval=TRUE,message=FALSE,cache=TRUE,fig.align="center",out.width="50%")
```

# Adjusted hr frequencies, 2012-2021.

Let us see how the batter-pitcher combination (`bpcombo`) frequencies have
varied over time

```{r plot1, out.width="50%", fig.align="center",echo=FALSE}
load("./allyrs.12vars.RData")
allyrs.12vars %>% select(BAT_HAND_CD,PIT_HAND_CD) %>% table %>% prop.table -> bpfrqs.era
# all four combo frqs
bpfrqs.era
# batter hand
print("by Batter Hand (row sums)")
bpfrqs.era %>% rowSums()
# pitcher hand
print("by Pitcher Hand (col sums)")
bpfrqs.era %>% colSums()
# conditionally on batter hand
print("Conditionally on Batter Hand")
allyrs.12vars %>% select(BAT_HAND_CD,PIT_HAND_CD) %>% table %>% prop.table(margin="BAT_HAND_CD")  -> bhtable; bhtable
# conditionally on pitcher hand
print("Conditionally on Pitcher Hand")
allyrs.12vars %>% select(BAT_HAND_CD,PIT_HAND_CD) %>% table %>% prop.table(margin="PIT_HAND_CD") 
# later, we'll look at these frs as a vector
print("All four relative freqs as a vector")
bpfrqs.era %>% as.data.frame  -> bpfrqs.era.vec ; bpfrqs.era.vec %>% print
```

\newpage

These four bpcombo frequencies have changed little over time, though the preference
for LHB when facing RHP may have decreased slightly.
```{r plot2, echo=FALSE}
allyrs.12vars %>% select(BAT_HAND_CD,PIT_HAND_CD,season) %>% table -> bpfrq.array

bpfrq.array %>% prop.table(margin=c("season")) -> bpfrq.byyear
plot(names(bpfrq.byyear[2,2,]),bpfrq.byyear[2,2,],ylim=c(0,0.7),type="b",lty=1,
     xlab="season",ylab="BPCombo Frequency",main="Batter/pitcher combo frqs over time",lwd=1.5)
lines(names(bpfrq.byyear[1,2,]),bpfrq.byyear[1,2,],type="b",lty=2)
lines(names(bpfrq.byyear[2,1,]),bpfrq.byyear[2,1,],type="b",lty=1,col="red")
lines(names(bpfrq.byyear[1,1,]),bpfrq.byyear[1,1,],type="b",lty=2,col="red")
legend(2012,0.7,c("RHBRHP","LHBRHP","RHBLHP","LHBLHP"),lty=c(1,2,1,2),col=c("black","black","red","red"),lwd=1.5)

allyrs.12vars %>% group_by(BAT_HAND_CD,PIT_HAND_CD) %>% summarize(count=n()) %>% 
  mutate(relfreq=count/sum(count)) -> bpfrq.vec
```
The effects of bpcombo on home run frequency can be investigated with an interaction plot, generated with data from 2012-2021:
```{r bpfrqs.era}
allyrs.12vars %>% group_by(BAT_HAND_CD,PIT_HAND_CD) %>% summarize(hrfrq=mean(hr)) -> hrfrq.bp.era
hrfrq.bp.era
ggplot(hrfrq.bp.era,aes(y=hrfrq,x=BAT_HAND_CD,color=PIT_HAND_CD)) + 
  geom_line(aes(group=PIT_HAND_CD)) + geom_point() + 
  ggtitle("BP Combo effect on P(HR), 2012-2021")
```
Looking over this 10 year period, it can be seen that home runs are least likely when
a LHB is facing a LHP.  Remarkably, the effect of the batter hand only appears 
to matter when facing lefties.  Wow!

For a given park, the frequencies of the four combinations can vary dramatically 
from one season to the next, depending upon the personnel of the home team and with
the unbalanced schedules of years past, upon the personnel of other teams in the
division.  In light of bpcombo effects, home run frequencies for each park can
be adjusted to league-wide bpcombo frequencies simply by reweighting the
four conditional home run rates to the these frequencies.  

```{r adjplot1}
allyrs.12vars %>% group_by(park,BAT_HAND_CD,PIT_HAND_CD) %>% 
  summarize(hrfrq=mean(hr)) %>% pivot_wider(values_from=hrfrq,
                                names_from=c("BAT_HAND_CD","PIT_HAND_CD")) ->
  hrsummary.wide
hrsummary.wide %>% mutate(adjhr=bpfrqs.era[1,1]*L_L + bpfrqs.era[1,2]*L_R + 
                                bpfrqs.era[2,1]*R_L + bpfrqs.era[2,2]*R_R) ->
  hrsummary.wide 
# unadjusted
allyrs.12vars %>% group_by(park) %>% summarize(obshr=mean(hr)) -> hrfrqs.bypark
hrsummary.wide %>% inner_join(hrfrqs.bypark) -> hrsummary.wide
```
These adjusted frequencies can be plotted against park, along with the unadjusted
frequencies.  Further investigation of changes over time is warranted though,
as a glance at 10-year averages still shows considerable variability in 
bpcombo frequencies across parks.  It must be kept in mind that many players
reside with the same team for long periods of time, so these 10 years are not
at all independent.  However, we average anyway ...

A technique worth mentioning in the construction of this plot is to achieve
an ordering of parks on the horizontal axis according to either the observed
or adjusted home run rate by so ordering the levels of park as a factor.
```{r orderpark}
hrsummary.wide$park <- factor(hrsummary.wide$park,
                              levels=hrsummary.wide$park[order(hrsummary.wide$adjhr)])
hrsummary.wide %>% pivot_longer(cols=c("adjhr","obshr"),values_to="phr") ->
  hrsummary.tall
```
Now `ggplot` can be used ...
```{r parkplot}
ggplot(hrsummary.tall) + geom_point(aes(y=phr,x=park,color=name)) + 
  theme(axis.text.x=element_text(angle=50)) + 
  ggtitle("HR Freqs, adj and observed \n 2012-2021")
```

\newpage

Ok, let us consider those teams for which the observed and adjusted hr freqs were different.
```{r rankdiffs}
hrsummary.wide %>% mutate(adjmnt=adjhr-obshr) %>% 
  arrange(abs(adjmnt)) -> hrsummary.wide; hrsummary.wide %>% tail
```
These differences between observed relative frequencies are small, but the number of plate appearances is large:
```{r pacount}
allyrs.12vars %>% group_by(park) %>% summarize(pa=n(),hr=sum(hr)) %>% 
  inner_join(hrsummary.wide) %>% mutate(hrdiff=adjmnt*pa) %>% 
  arrange(abs(hrdiff)) -> hrsummary.wide ; hrsummary.wide %>% tail
```
Each of the six teams that have the largest absolute adjustment have an
extreme value either for proportion of LHB or proportion of LHP.  First
the parks that host the _fewest_ plate appearances by LHB: 

```{r idextremes, echo=TRUE}
allyrs.12vars %>% select(park,BAT_HAND_CD) %>% table %>% prop.table(margin="park") %>%
  as.data.frame() %>% pivot_wider(values_from=Freq,names_from=BAT_HAND_CD) %>% 
  arrange(L) -> BHbyPark
BHbyPark %>% head
```
\newpage
Now for the _most_ plate appearances by LHB
```{r idextremes2, echo=TRUE}
BHbyPark %>% tail
```
Note that DET and TOR both see large downward adjustment and host the 2$^{nd}$ and 3$^{rd}$ lowest LHB frequencies at 38%.
CLE and MIN see large upward adjustment and host the most and third most
LHB, respectively (52% and 46% LHB!).

The other two teams for which adjusments are largest have extremes for plate 
appearances involving LHP:
```{r idextremePH}
allyrs.12vars %>% select(park,PIT_HAND_CD) %>% table %>% prop.table(margin="park") %>%
  as.data.frame() %>% pivot_wider(values_from=Freq,names_from=PIT_HAND_CD) %>% 
  arrange(L) -> PHbyPark
PHbyPark %>% head
PHbyPark %>% tail
```

Dodger Stadium (LAN) has seen the greatest number of plate appearances with a LHP
(36%) while Busch (SLN) has seen the second fewest (21%.)  The variation in frequency
of LHB across parks (38% for ANA up to 52% for CLE) and LHP (21% for MIL up to 36% for LAN) is remarkable.  Lineups and rotations are perhaps more stable than one might
think given all the personnel changes by high-profile free agents.

\newpage
# HR v park plots separated by batterhand

The adjusted HR Frequency for LHB is the weighted average
of observed HR frequencies against LHP and RHP, with weights
given by the conditionals from `bpcombos` on page 1
```{r hrvparklhb, fig.width=8,out.width="80%"}
allyrs.12vars %>% select(BAT_HAND_CD,PIT_HAND_CD) %>% table %>%
  prop.table(margin="BAT_HAND_CD") -> bhtable

# compute observed hr frqs by park
allyrs.12vars %>% group_by(park,BAT_HAND_CD,PIT_HAND_CD) %>% 
 summarize(hrfrq=mean(hr)) %>% 
  pivot_wider(values_from=hrfrq,
              names_from=c("BAT_HAND_CD","PIT_HAND_CD")) ->
  hrsummary.wide
# compute weighted HR freq for LHB and for RHB
hrsummary.wide %>% 
  mutate(adjhrLHB=bhtable[1,1]*L_L+bhtable[1,2]*L_R,
         adjhrRHB=bhtable[2,1]*R_L+bhtable[2,2]*R_R) ->
hrsummary.wide

# hrfrs by hand not adjusted for pitcher hand
allyrs.12vars %>% group_by(park,BAT_HAND_CD) %>% 
  summarize(hrfrq=mean(hr)) %>% 
  inner_join(hrsummary.wide) -> hrsummary.wide

# make LHB tall
hrsummary.wide %>% filter(BAT_HAND_CD=="L") -> hrsummary.wide.LHB
hrsummary.wide.LHB$park <- factor(hrsummary.wide.LHB$park,
 levels=hrsummary.wide.LHB$park[order(hrsummary.wide.LHB$adjhrLHB)])

hrsummary.wide.LHB %>%
  pivot_longer(cols=c("adjhrLHB","hrfrq"),values_to="phr") ->
  hrsummary.tall.LHB

# plot LHB
ggplot(hrsummary.tall.LHB) + geom_point(aes(y=phr,x=park,color=name))+
  theme(axis.text.x=element_text(angle=50)) +
  ggtitle("HR Freqs for LHB, adjusted and observed \n 2012-2021")
```

## Similarly for RHB,
```{r hrvparkrhb, fig.width=8,out.width="80%", echo=FALSE}
hrsummary.wide %>% filter(BAT_HAND_CD=="R") -> hrsummary.wide.RHB
hrsummary.wide.RHB$park <- factor(hrsummary.wide.RHB$park,
 levels=hrsummary.wide.RHB$park[order(hrsummary.wide.RHB$adjhrRHB)])

hrsummary.wide.RHB %>%
  pivot_longer(cols=c("adjhrRHB","hrfrq"),values_to="phr") ->
  hrsummary.tall.RHB

# plot RHB
ggplot(hrsummary.tall.RHB) + geom_point(aes(y=phr,x=park,color=name)) +
  theme(axis.text.x=element_text(angle=50)) +
  ggtitle("HR Freqs for RHB, adjusted and observed \n 2012-2021")
hrsummary.wide.era <- hrsummary.wide
```

For which ballparks is the ranking for LHB furthest from the ranking for RHB?
```{r comparelr}
hsummary.wide.era
```


\newpage 

\newpage

To investigate variability of adjusted and unadjusted HR freqs and
also variability among rankings, we will here obtain graphs for the
2021 season alone.  Firstly, HR freqs averaged over BH, to be followed
by separate plots for LHB and RHB.
```{r a2021}
bpfrqs.2021 <- bpfrq.byyear[,,10] # computed earlier
allyrs.12vars %>% filter(season==2021) %>% 
  group_by(park,BAT_HAND_CD,PIT_HAND_CD) %>% 
  summarize(hrfrq=mean(hr)) %>% pivot_wider(values_from=hrfrq,
                                names_from=c("BAT_HAND_CD","PIT_HAND_CD")) ->
  hrsummary.wide.2021
hrsummary.wide.2021 %>% mutate(adjhr=bpfrqs.2021[1,1]*L_L + bpfrqs.2021[1,2]*L_R + 
                                bpfrqs.2021[2,1]*R_L + bpfrqs.2021[2,2]*R_R) ->
  hrsummary.wide.2021 
# unadjusted
allyrs.12vars %>% filter(season==2021) %>% group_by(park) %>% summarize(obshr=mean(hr)) -> hrfrqs.bypark.2021
hrsummary.wide.2021 %>% inner_join(hrfrqs.bypark.2021) -> hrsummary.wide.2021
hrsummary.wide.2021$park <- factor(hrsummary.wide.2021$park,
                     levels=hrsummary.wide.2021$park[order(hrsummary.wide.2021$adjhr)])
hrsummary.wide.2021 %>% pivot_longer(cols=c("adjhr","obshr"),values_to="phr") ->
  hrsummary.tall.2021
```
Now `ggplot` can be used ...
```{r parkplot2021}
ggplot(hrsummary.tall.2021) + geom_point(aes(y=phr,x=park,color=name)) + 
  ggtitle("HR Freqs, adj and observed \n only the 2021 season") + 
  theme(axis.text.x=element_text(angle=50))
```
The data:
```{r data2021}
hrsummary.tall.2021 %>% print(n=5)
```
Now for 2021 plots specific to batter hand.  Code available upon request!

```{r tmp2, echo=FALSE, fig.width=8,out.width="80%"}
allyrs.12vars %>% filter(season==2021) %>% 
  select(BAT_HAND_CD,PIT_HAND_CD) %>% table %>%
  prop.table(margin="BAT_HAND_CD") -> bhtable

allyrs.12vars %>% filter(season==2021) %>% 
  group_by(park,BAT_HAND_CD,PIT_HAND_CD) %>%
  summarize(hrfrq=mean(hr)) %>% 
  pivot_wider(values_from=hrfrq,
              names_from=c("BAT_HAND_CD","PIT_HAND_CD")) ->
  hrsummary.wide.2021
hrsummary.wide.2021 %>%
  mutate(adjhrLHB=bhtable[1,1]*L_L + bhtable[1,2]*L_R,
         adjhrRHB=bhtable[2,1]*R_L + bhtable[2,2]*R_R) ->
hrsummary.wide.2021

allyrs.12vars %>% filter(season==2021) %>% 
  group_by(park,BAT_HAND_CD) %>%
  summarize(hrfrq=mean(hr)) %>% 
  inner_join(hrsummary.wide.2021) -> hrsummary.wide.2021

hrsummary.wide.2021 %>% filter(BAT_HAND_CD=="L") -> hrsummary.wide.2021.LHB
hrsummary.wide.2021 %>% filter(BAT_HAND_CD=="R") -> hrsummary.wide.2021.RHB

hrsummary.wide.2021.LHB$park <- factor(hrsummary.wide.2021.LHB$park,
 levels=hrsummary.wide.2021.LHB$park[order(hrsummary.wide.2021.LHB$adjhrLHB)])

hrsummary.wide.2021.RHB$park <- factor(hrsummary.wide.2021.RHB$park,
 levels=hrsummary.wide.2021.RHB$park[order(hrsummary.wide.2021.RHB$adjhrRHB)])

hrsummary.wide.2021.LHB %>% 
  pivot_longer(cols=c("adjhrLHB","hrfrq"),values_to="phr") -> 
  hrsummary.tall.2021.LHB
hrsummary.wide.2021.RHB %>% 
  pivot_longer(cols=c("adjhrRHB","hrfrq"),values_to="phr") -> 
  hrsummary.tall.2021.RHB

ggplot(hrsummary.tall.2021.LHB) + geom_point(aes(y=phr,x=park,color=name)) + 
  theme(axis.text.x=element_text(angle=50)) + 
  ggtitle("HR Freqs for LHB, adj and observed in 2021 only")

ggplot(hrsummary.tall.2021.RHB) + geom_point(aes(y=phr,x=park,color=name)) + 
  theme(axis.text.x=element_text(angle=50)) + 
  ggtitle("HR Freqs for RHB, adj and observed in 2021 only")
```

\newpage 

Compute ranks for comparison of observed v fitted for LHB and for RHB
```{r rankl, echo=FALSE}
library(knitr)
rLHBobs<-rank(hrsummary.wide.2021.LHB$hrfrq)
rLHBfit<-rank(hrsummary.wide.2021.LHB$adjhrLHB)
hrsummary.wide.2021.LHB %>% add_column(rLHBobs,rLHBfit) -> ranks.LHB
ranks.LHB %>% arrange(rLHBfit) %>% select(-2) -> ranks.LHB2
knitr::kable(ranks.LHB2,digits=3)
```
Some observations upon inspection of these plots and ranking  
* Coors Field is middle of the road (#13) for LHB!
* Yankee Stadium is indeed homer-friendly to LHB (), even more so if reweighting
observed home run rates to league-wide matchup frequencies.
* Jacobs Field (CLE) and T-Moble (SEA) swith places in the ranking after
adjustment, with CLE seeing a higher rate of observed HRs by LHB than would
be expected for league-wide matchup frequencies
* Both parks in Chicago saw more HRs by LHB than would be expected with
league wide matchup frequencies

```{r rankr, echo=FALSE}
r_RHB_obs<-rank(-hrsummary.wide.2021.RHB$hrfrq)
r_RHB_fit<-rank(-hrsummary.wide.2021.RHB$adjhrRHB)
hrsummary.wide.2021.RHB %>% add_column(r_RHB_obs,r_RHB_fit) -> ranks.RHB
ranks.RHB %>% select(-4:-7) %>% arrange(r_RHB_fit) %>% print(n=30)
```







\newpage


I'd bet that the agreement between 2021 adjusted HRs and _era_ observed
HRs is greater than agreement between 2021 observed HRs and _era_ observed HRs.



```{r exit2,cache=FALSE}
library(knitr)
knitr::knit_exit()
```

```{r compLR, echo=FALSE}
hrsummary.wide.2021 %>% rename(hrfrq.2021 = hrfrq,
                               adjLHB.2021=adjhrLHB,
                               adjRHB.2021=adjhrRHB) %>% 
  select(c(-2,-4:-7)) -> hrsummary.wide.2021

hrsummary.wide.era %>% select(-4:-7) %>% inner_join(hrsummary.wide.2021) ->
  hrsummary.wide.both; print(hrsummary.wide.both,n=5)

print(cor(hrsummary.wide.both["BAT_HAND_CD"=="L",3:8]))
print(cor(hrsummary.wide.both["BAT_HAND_CD"=="R",3:8]))
```

\newpage 


# Leftover page from earlier draft

Were bpcombo freqs for `CLE` different from those of the rest of the league?
```{r bpcombos}
allyrs.12vars %>% select(park,BAT_HAND_CD,PIT_HAND_CD) %>% table %>%
  prop.table(margin=c("park")) %>% as.data.frame -> teambpfrqs.tall
teambpfrqs.tall %>% filter(park=="CLE") %>% print
# Glancing back at era frequencies:
bpfrqs.era.vec %>% print 
```
For whatever reason, there were considerably more PA involving Pitchers and Batters
of the same hand (RHBRHP or LHBLHP) at Jacobs Field, resulting in upward
adjustment to era frequencies (so long as CLE conditional HR rates not too different.)

For other teams, we compute team combo frequencies relative era combo frequencies

```{r team2era}
allyrs.12vars %>% group_by(BAT_HAND_CD,PIT_HAND_CD) %>% summarize(count=n()) %>%
  ungroup %>% mutate(relFreq=count/sum(count)) -> bptotals
teambpfrqs.tall %>% inner_join(bptotals) %>% 
  mutate(team2era = Freq/relFreq) -> team2era 
team2era %>%  arrange(park,BAT_HAND_CD,PIT_HAND_CD)  %>% 
  filter(park %in% c("CLE","SLN","LAN","DET","MIN","TOR")) %>% print
```
A reminder of which combos lead to the most HRs
```{r hrfrq}
allyrs.12vars %>% group_by(BAT_HAND_CD,PIT_HAND_CD) %>% summarize(hrfrq=mean(hr),hrsum=sum(hr))
```

\newpage


